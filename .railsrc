def db_inspect
  ActiveRecord::Base.connection.tables.sort.each do |table|
    count = ActiveRecord::Base.connection.select_value("SELECT COUNT(*) FROM #{table}").to_i
    puts "%10s #{table}" % count
  end
  nil
end

def active_record_log(stream)
  ActiveRecord::Base.logger = Logger.new(stream)
  ActiveRecord::Base.clear_all_connections!
  nil
end

def sql_on
  active_record_log(STDOUT)
end

def sql_off
  active_record_log(nil)
end

def sql(query)
  ActiveRecord::Base.connection.select_all(query)
end

def sql_bench(query, runs = 10)
  puts
  puts sql("EXPLAIN ANALYZE VERBOSE #{query}").map(&:values).flatten.join("\n")
  puts
  puts "#{runs} runs in"
  runs_time = Benchmark.realtime { runs.times { sql(query) } }
  puts "  #{runs_time}"
end
